name: Update Coffee Status

on:
  # Allow manual trigger with input parameter
  workflow_dispatch:
    inputs:
      coffee_status:
        description: 'Coffee status (true for ON, false for OFF)'
        required: true
        type: boolean
        default: true

# Permissions needed for creating PRs and pushing
permissions:
  contents: write
  pull-requests: write

jobs:
  update-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate next Sunday and update files
        id: update
        run: |
          # Calculate next Sunday
          NEXT_SUNDAY=$(node -e "
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilSunday = dayOfWeek === 0 ? 7 : (7 - dayOfWeek);
            const nextSunday = new Date(today);
            nextSunday.setDate(today.getDate() + daysUntilSunday);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            console.log(nextSunday.toLocaleDateString('en-US', options));
          ")
          echo "next_sunday=${NEXT_SUNDAY}" >> $GITHUB_OUTPUT
          
          BRANCH_DATE=$(node -e "
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilSunday = dayOfWeek === 0 ? 7 : (7 - dayOfWeek);
            const nextSunday = new Date(today);
            nextSunday.setDate(today.getDate() + daysUntilSunday);
            const year = nextSunday.getFullYear();
            const month = String(nextSunday.getMonth() + 1).padStart(2, '0');
            const day = String(nextSunday.getDate()).padStart(2, '0');
            console.log(\`\${year}-\${month}-\${day}\`);
          ")
          echo "branch_date=${BRANCH_DATE}" >> $GITHUB_OUTPUT
          
          # Update index.html using Node.js
          node -e "
            const fs = require('fs');
            const coffeeStatus = '${{ inputs.coffee_status }}' === 'true';
            const nextSundayStr = '${NEXT_SUNDAY}';
            
            const today = new Date();
            const lastUpdatedStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let content = fs.readFileSync('index.html', 'utf8');
            
            // Update body class
            const statusClass = coffeeStatus ? 'status-on' : 'status-off';
            // Use ^ anchor to match body tag at line start, avoiding matches in comments above
            content = content.replace(
              /^<body class=\"status-(on|off)\">/m,
              \`<body class=\"\${statusClass}\">\`
            );
            
            // Update date line
            content = content.replace(
              /<div class=\"date\">.*?<\/div>/,
              \`<div class=\"date\">\${nextSundayStr}</div>\`
            );
            
            // Update last updated
            content = content.replace(
              /<strong>Last updated:<\/strong>\s+[A-Za-z]+\s+\d+,\s+\d+/,
              \`<strong>Last updated:</strong> \${lastUpdatedStr}\`
            );
            
            fs.writeFileSync('index.html', content, 'utf8');
            console.log('âœ… Updated index.html');
          "

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update-${{ steps.update.outputs.branch_date }}
          base: main
          title: "Update coffee status for ${{ steps.update.outputs.next_sunday }}"
          body: |
            ## Coffee Status Update
            
            **Status**: ${{ fromJSON(inputs.coffee_status) && 'â˜• Coffee is ON' || 'ðŸ˜¢ Coffee is OFF' }}
            **Date**: ${{ steps.update.outputs.next_sunday }}
            
            This PR was automatically generated by the Update Coffee Status workflow.
            
            ### Changes
            - Updated coffee status to `${{ fromJSON(inputs.coffee_status) && 'status-on' || 'status-off' }}`
            - Updated date to ${{ steps.update.outputs.next_sunday }}
            - Updated last modified timestamp
            
            ---
            *This PR will be automatically merged.*
          commit-message: "Update coffee status for ${{ steps.update.outputs.next_sunday }}"
          delete-branch: true

      - name: Merge Pull Request
        if: steps.create-pr.outputs.pull-request-number != ''
        run: |
          # Wait a moment for PR to be fully created
          sleep 2
          
          # Merge the PR
          gh pr merge "${{ steps.create-pr.outputs.pull-request-number }}" --squash --auto --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
